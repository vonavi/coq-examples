<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" class="alectryon-standalone" xml:lang="en" lang="en">
<head>
<meta charset="utf-8" />
<meta name="generator" content="Docutils 0.20.1: https://docutils.sourceforge.io/" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Existential goals are filled in too soon</title>
<link rel="stylesheet" href="alectryon.css" type="text/css" />
<link rel="stylesheet" href="docutils_basic.css" type="text/css" />
<link rel="stylesheet" href="pygments.css" type="text/css" />
<script type="text/javascript" src="alectryon.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/IBM-type/0.5.4/css/ibm-type.min.css" integrity="sha512-sky5cf9Ts6FY1kstGOBHSybfKqdHR41M0Ldb0BjNiv3ifltoQIsg0zIaQ+wwdwgQ0w9vKFW7Js50lxH9vqNSSw==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/firacode/5.2.0/fira_code.min.css" integrity="sha512-MbysAYimH1hH2xYzkkMHB6MqxBqfP0megxsCLknbYqHVwXTCg9IqHbk+ZP/vnhO8UEW6PaXAkKe2vQ+SWACxxA==" crossorigin="anonymous" />
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<div class="alectryon-root alectryon-centered"><main id="existential-goals-are-filled-in-too-soon">
<h1 class="title">Existential goals are filled in too soon</h1>
<dl class="docinfo simple">
<dt class="link">Link<span class="colon">:</span></dt>
<dd class="link"><p><a class="reference external" href="https://stackoverflow.com/q/51332966">https://stackoverflow.com/q/51332966</a></p>
</dd>
</dl>
<input type="checkbox" class="alectryon-toggle" id="alectryon-toggle-0" /><label for="alectryon-toggle-0" class="alectryon-toggle-label">Display all goals and responses</label><div class="alectryon-container docutils container">
<section id="question">
<h2>Question</h2>
<p>I have a <span class="docutils literal">Class</span> containing both data and axioms. I want to build
another instance in proof mode, based on (1) an existing instance and
(2) some other input. I want to <span class="docutils literal">destruct</span> this second input before
creating the new instance of the record.</p>
<p>The minimal <span class="docutils literal">Class</span> that works as an example is shrunk from one in
<a class="reference external" href="https://github.com/jwiegley/category-theory">jwiegley/category-theory</a>:</p>
<pre class="alectryon-io highlight"><!-- Generator: Alectryon --><span class="alectryon-sentence"><span class="alectryon-input"><span class="kn">Require Import</span> Coq.Unicode.Utf8.</span><span class="alectryon-wsp">
</span></span><span class="alectryon-sentence"><span class="alectryon-input"><span class="kn">Require Import</span> Coq.Init.Datatypes.</span><span class="alectryon-wsp">
</span></span><span class="alectryon-sentence"><span class="alectryon-input"><span class="kn">Require Import</span> Coq.Classes.Morphisms.</span><span class="alectryon-wsp">
</span></span><span class="alectryon-sentence"><span class="alectryon-input"><span class="kn">Require Import</span> Coq.Classes.SetoidDec.</span><span class="alectryon-wsp">
</span></span><span class="alectryon-wsp">
</span><span class="alectryon-sentence"><span class="alectryon-input"><span class="kn">Generalizable All Variables</span>.</span><span class="alectryon-wsp">
</span></span><span class="alectryon-wsp">
</span><span class="alectryon-sentence"><span class="alectryon-input"><span class="kn">Reserved Infix</span> <span class="s2">&quot;~&gt;&quot;</span> (<span class="kn">at level</span> <span class="mi">90</span>, <span class="kn">right associativity</span>).</span><span class="alectryon-wsp">
</span></span><span class="alectryon-sentence"><span class="alectryon-input"><span class="kn">Reserved Infix</span> <span class="s2">&quot;∘&quot;</span> (<span class="kn">at level</span> <span class="mi">40</span>, <span class="kn">left associativity</span>).</span><span class="alectryon-wsp">
</span></span><span class="alectryon-wsp">
</span><span class="alectryon-sentence"><input class="alectryon-toggle" id="existential-goals-are-filled-in-too-soon-v-chk0" style="display: none" type="checkbox"><label class="alectryon-input" for="existential-goals-are-filled-in-too-soon-v-chk0"><span class="kn">Record</span> <span class="nf">Category</span> := {
    obj : <span class="kt">Type</span>;

    uhom := <span class="kt">Type</span> : <span class="kt">Type</span>;
    hom : obj -&gt; obj -&gt; uhom <span class="kn">where</span> <span class="s2">&quot;a ~&gt; b&quot;</span> := (hom a b);
    homset :&gt; <span class="kr">∀</span> <span class="nv">X</span> <span class="nv">Y</span>, Setoid (X ~&gt; Y);

    compose {x y z} (f: y ~&gt; z) (g : x ~&gt; y) : x ~&gt; z
    <span class="kn">where</span> <span class="s2">&quot;f ∘ g&quot;</span> := (compose f g);

    compose_respects x y z :&gt;
                     Proper (equiv ==&gt; equiv ==&gt; equiv) (@compose x y z);
  }.</label><small class="alectryon-output"><div><div class="alectryon-messages"><blockquote class="alectryon-message">New coercion path [compose_respects] : Category &gt;-&gt; <span class="kt">Funclass</span> <span class="kr">is</span> ambiguous <span class="kr">with</span> existing 
[homset] : Category &gt;-&gt; <span class="kt">Funclass</span>.
[ambiguous-paths,typechecker]</blockquote></div></div></small></span></pre><p>Suppose (2) is bool:</p>
<pre class="alectryon-io highlight"><!-- Generator: Alectryon --><span class="alectryon-sentence"><input class="alectryon-toggle" id="existential-goals-are-filled-in-too-soon-v-chk1" style="display: none" type="checkbox"><label class="alectryon-input" for="existential-goals-are-filled-in-too-soon-v-chk1"><span class="kn">Definition</span> <span class="nf">newCat</span> (<span class="nv">C</span> : Category) (<span class="nv">b</span> : bool) : Category.</label><small class="alectryon-output"><div><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span><var>C</var><span class="hyp-type"><b>: </b><span>Category</span></span></span><br><span><var>b</var><span class="hyp-type"><b>: </b><span>bool</span></span></span><br></div><span class="goal-separator"><hr></span><div class="goal-conclusion">Category</div></blockquote></div></div></small><span class="alectryon-wsp">
</span></span><span class="alectryon-sentence"><input class="alectryon-toggle" id="existential-goals-are-filled-in-too-soon-v-chk2" style="display: none" type="checkbox"><label class="alectryon-input" for="existential-goals-are-filled-in-too-soon-v-chk2"><span class="kn">Proof</span>.</label><small class="alectryon-output"><div><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span><var>C</var><span class="hyp-type"><b>: </b><span>Category</span></span></span><br><span><var>b</var><span class="hyp-type"><b>: </b><span>bool</span></span></span><br></div><span class="goal-separator"><hr></span><div class="goal-conclusion">Category</div></blockquote></div></div></small><span class="alectryon-wsp">
</span></span><span class="alectryon-wsp">  </span><span class="alectryon-sentence"><input class="alectryon-toggle" id="existential-goals-are-filled-in-too-soon-v-chk3" style="display: none" type="checkbox"><label class="alectryon-input" for="existential-goals-are-filled-in-too-soon-v-chk3"><span class="nb">destruct</span> b.</label><small class="alectryon-output"><div><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span><var>C</var><span class="hyp-type"><b>: </b><span>Category</span></span></span><br></div><span class="goal-separator"><hr></span><div class="goal-conclusion">Category</div></blockquote><div class="alectryon-extra-goals"><input class="alectryon-extra-goal-toggle" id="existential-goals-are-filled-in-too-soon-v-chk4" style="display: none" type="checkbox"><blockquote class="alectryon-goal"><div class="goal-hyps"><span><var>C</var><span class="hyp-type"><b>: </b><span>Category</span></span></span><br></div><label class="goal-separator" for="existential-goals-are-filled-in-too-soon-v-chk4"><hr></label><div class="goal-conclusion">Category</div></blockquote></div></div></div></small><span class="alectryon-wsp">
</span></span><span class="alectryon-wsp">  </span><span class="alectryon-sentence"><input class="alectryon-toggle" id="existential-goals-are-filled-in-too-soon-v-chk5" style="display: none" type="checkbox"><label class="alectryon-input" for="existential-goals-are-filled-in-too-soon-v-chk5">-</label><small class="alectryon-output"><div><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span><var>C</var><span class="hyp-type"><b>: </b><span>Category</span></span></span><br></div><span class="goal-separator"><hr></span><div class="goal-conclusion">Category</div></blockquote></div></div></small><span class="alectryon-wsp"> </span></span><span class="alectryon-sentence"><input class="alectryon-toggle" id="existential-goals-are-filled-in-too-soon-v-chk6" style="display: none" type="checkbox"><label class="alectryon-input" for="existential-goals-are-filled-in-too-soon-v-chk6"><span class="nb">eapply</span> Build_Category.</label><small class="alectryon-output"><div><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span><var>C</var><span class="hyp-type"><b>: </b><span>Category</span></span></span><br></div><span class="goal-separator"><hr></span><div class="goal-conclusion"><span class="kr">∀</span> <span class="nv">x</span> <span class="nv">y</span> <span class="nv">z</span> : <span class="kt">Type</span>,
  Proper (equiv ==&gt; equiv ==&gt; equiv) (<span class="nl">?compose</span> x y z)</div></blockquote></div></div></small><span class="alectryon-wsp"> </span></span><span class="alectryon-sentence"><input class="alectryon-toggle" id="existential-goals-are-filled-in-too-soon-v-chk7" style="display: none" type="checkbox"><label class="alectryon-input" for="existential-goals-are-filled-in-too-soon-v-chk7"><span class="kn">Unshelve</span>.</label><small class="alectryon-output"><div><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span><var>C</var><span class="hyp-type"><b>: </b><span>Category</span></span></span><br></div><span class="goal-separator"><hr></span><div class="goal-conclusion"><span class="kr">∀</span> <span class="nv">x</span> <span class="nv">y</span> <span class="nv">z</span> : <span class="kt">Type</span>,
  Proper (equiv ==&gt; equiv ==&gt; equiv) (<span class="nl">?compose</span> x y z)</div></blockquote><div class="alectryon-extra-goals"><input class="alectryon-extra-goal-toggle" id="existential-goals-are-filled-in-too-soon-v-chk8" style="display: none" type="checkbox"><blockquote class="alectryon-goal"><div class="goal-hyps"><span><var>C</var><span class="hyp-type"><b>: </b><span>Category</span></span></span><br></div><label class="goal-separator" for="existential-goals-are-filled-in-too-soon-v-chk8"><hr></label><div class="goal-conclusion"><span class="kr">∀</span> <span class="nv">x</span> <span class="nv">y</span> <span class="nv">z</span> : <span class="kt">Type</span>,
  (<span class="kr">λ</span> <span class="nv">_</span> <span class="nv">A</span> : <span class="kt">Type</span>, A) y z
  → (<span class="kr">λ</span> <span class="nv">_</span> <span class="nv">A</span> : <span class="kt">Type</span>, A) x y → (<span class="kr">λ</span> <span class="nv">_</span> <span class="nv">A</span> : <span class="kt">Type</span>, A) x z</div></blockquote></div></div></div></small></span></pre><p>At this point, <span class="docutils literal">obj</span> is filled in with <span class="docutils literal">Type</span>:</p>
<pre class="alectryon-io highlight"><!-- Generator: Alectryon --><span class="alectryon-sentence"><input checked="checked" class="alectryon-toggle" id="existential-goals-are-filled-in-too-soon-v-chk9" style="display: none" type="checkbox"><small class="alectryon-output"><div><div class="alectryon-messages"><blockquote class="alectryon-message"><span class="mi">2</span> subgoals

  C : Category
  ============================
  <span class="kr">∀</span> <span class="nv">x</span> <span class="nv">y</span> <span class="nv">z</span> : <span class="kt">Type</span>,
    Proper (equiv ==&gt; equiv ==&gt; equiv)
      (<span class="nl">?compose</span> x y z)

subgoal <span class="mi">2</span> <span class="kr">is</span>:
 <span class="kr">∀</span> <span class="nv">x</span> <span class="nv">y</span> <span class="nv">z</span> : <span class="kt">Type</span>,
   (<span class="kr">λ</span> <span class="nv">_</span> <span class="nv">A</span> : <span class="kt">Type</span>, A) y z
   → (<span class="kr">λ</span> <span class="nv">_</span> <span class="nv">A</span> : <span class="kt">Type</span>, A) x y → (<span class="kr">λ</span> <span class="nv">_</span> <span class="nv">A</span> : <span class="kt">Type</span>, A) x z</blockquote></div></div></small></span></pre><p>This behavior disappears if I remove the <span class="docutils literal">compose_respects</span> axiom
(or use some other kind of <span class="docutils literal">Record</span> without such a field). If I
change <span class="docutils literal">Category</span> into a <span class="docutils literal">Class</span>, <span class="docutils literal">obj</span> will be filled in as the
<span class="docutils literal">obj</span> of <span class="docutils literal">C</span>. It seems to have something to do with typeclass
resolution (the fact that the <span class="docutils literal">equiv</span>s have implicit typeclass
arguments?).</p>
<p>Is there someway to prevent these (or any!) variables from being
filled in with unification? The optimal result would be something like
<span class="docutils literal">eapply</span>+<span class="docutils literal">Unshelve</span> where no existentials are generated at
all, and I can fill in the record's fields as subgoals, in order.</p>
</section>
<section id="answer">
<h2>Answer</h2>
<p>It looks like <span class="docutils literal">simple notypeclasses refine {| obj := _ |}</span> does the
trick.</p>
<ul class="simple">
<li><p><span class="docutils literal">{| obj := _|}</span> is record syntax that functions as shorthand for
<span class="docutils literal">Build_Category _ _ _ _ _</span>.</p></li>
<li><p><span class="docutils literal">simple notypeclasses refine</span> is all one tactic. It's a variant of
<span class="docutils literal">notypeclasses refine</span> that doesn't shelve goals and performs no
reduction.</p></li>
<li><p>Sadly there isn't a generic <span class="docutils literal">notypeclasses</span> combinator, unlike
<span class="docutils literal">unshelve</span>. There's just <span class="docutils literal">notypeclasses refine</span> and <span class="docutils literal">simple notypeclasses refine</span>.</p></li>
</ul>
<p>For debugging, you can use the (undocumented) <span class="docutils literal">Set Typeclasses Debug</span>. This reveals that <span class="docutils literal">eapply Build_Category</span> does resolve some
typeclasses, and <span class="docutils literal">refine {| obj := _|}</span> is even worse.</p>
<p>As an aside, I don't think it makes sense to have <span class="docutils literal">Class Category</span>
without any type-level parameters - why would you ever want just any
category automatically inferred?</p>
</section>
</div>
</main>
</div></body>
</html>
