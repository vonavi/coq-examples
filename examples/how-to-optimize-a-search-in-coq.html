<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" class="alectryon-standalone" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.20.1: https://docutils.sourceforge.io/" />
<title>How to optimize a search in Coq</title>
<link rel="stylesheet" href="alectryon.css" type="text/css" />
<link rel="stylesheet" href="docutils_basic.css" type="text/css" />
<link rel="stylesheet" href="pygments.css" type="text/css" />
<script type="text/javascript" src="alectryon.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/IBM-type/0.5.4/css/ibm-type.min.css" integrity="sha512-sky5cf9Ts6FY1kstGOBHSybfKqdHR41M0Ldb0BjNiv3ifltoQIsg0zIaQ+wwdwgQ0w9vKFW7Js50lxH9vqNSSw==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/firacode/5.2.0/fira_code.min.css" integrity="sha512-MbysAYimH1hH2xYzkkMHB6MqxBqfP0megxsCLknbYqHVwXTCg9IqHbk+ZP/vnhO8UEW6PaXAkKe2vQ+SWACxxA==" crossorigin="anonymous" />
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<div class="alectryon-root alectryon-centered"><div class="document" id="how-to-optimize-a-search-in-coq">
<h1 class="title">How to optimize a search in Coq</h1>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr class="link field"><th class="docinfo-name">Link:</th><td class="field-body"><a class="reference external" href="https://stackoverflow.com/q/19747308">https://stackoverflow.com/q/19747308</a></td>
</tr>
</tbody>
</table>
<input type="checkbox" class="alectryon-toggle" id="alectryon-toggle-0" /><label for="alectryon-toggle-0" class="alectryon-toggle-label">Display all goals and responses</label><div class="alectryon-container docutils container">
<div class="section" id="question">
<h1>Question</h1>
<p>I have a simple search function for a property that I am interested
in, and a proof that the function is correct. I want to evaluate the
function, and use the correctness proof to get the theorem for the
original property. Unfortunately, evaluation in Coq is very slow. As a
trivial example, consider looking for square roots:</p>
<pre class="alectryon-io highlight"><!-- Generator: Alectryon --><span class="alectryon-wsp"><span class="c">(* Coq 8.4</span>
<span class="c">   A simple example to demonstrate searching.</span>
<span class="c">   Timings are rough and approximate. *)</span>

</span><span class="alectryon-sentence"><span class="alectryon-input"><span class="kn">Require Import</span> Peano_dec.</span><span class="alectryon-wsp">
</span></span><span class="alectryon-wsp">
</span><span class="alectryon-sentence"><span class="alectryon-input"><span class="kn">Definition</span> <span class="nf">SearchSqrtLoop</span> :=
  <span class="kr">fix</span> f i n := <span class="kr">if</span> eq_nat_dec (i * i) n
               <span class="kr">then</span> i
               <span class="kr">else</span> <span class="kr">match</span> i <span class="kr">with</span>
                    | <span class="mi">0</span> =&gt; <span class="mi">0</span> <span class="c">(* ~ Square n \/ n = 0 *)</span>
                    | S j =&gt; f j n
                    <span class="kr">end</span>.</span><span class="alectryon-wsp">
</span></span><span class="alectryon-wsp">
</span><span class="alectryon-sentence"><span class="alectryon-input"><span class="kn">Definition</span> <span class="nf">SearchSqrt</span> <span class="nv">n</span> := SearchSqrtLoop n n.</span><span class="alectryon-wsp">
</span></span><span class="alectryon-wsp">
<span class="c">(* Compute SearchSqrt 484.</span>
<span class="c">   takes about 30 seconds. *)</span>

</span><span class="alectryon-sentence"><input class="alectryon-toggle" id="how-to-optimize-a-search-in-coq-v-chk0" style="display: none" type="checkbox"><label class="alectryon-input" for="how-to-optimize-a-search-in-coq-v-chk0"><span class="kn">Theorem</span> <span class="nf">sqrt_484a</span> : SearchSqrt <span class="mi">484</span> = <span class="mi">22</span>.</label><small class="alectryon-output"><div><div class="alectryon-goals"><blockquote class="alectryon-goal"><span class="goal-separator"><hr></span><div class="goal-conclusion">SearchSqrt <span class="mi">484</span> = <span class="mi">22</span></div></blockquote></div></div></small><span class="alectryon-wsp">
</span></span><span class="alectryon-wsp">  </span><span class="alectryon-sentence"><span class="alectryon-input"><span class="nb">apply</span> eq_refl. <span class="c">(* 100 seconds *)</span></span><span class="alectryon-wsp">
</span></span><span class="alectryon-sentence"><span class="alectryon-input"><span class="kn">Qed</span>. <span class="c">(* 50 seconds *)</span></span><span class="alectryon-wsp">
</span></span><span class="alectryon-wsp">
</span><span class="alectryon-sentence"><input class="alectryon-toggle" id="how-to-optimize-a-search-in-coq-v-chk1" style="display: none" type="checkbox"><label class="alectryon-input" for="how-to-optimize-a-search-in-coq-v-chk1"><span class="kn">Theorem</span> <span class="nf">sqrt_484b</span> : SearchSqrt <span class="mi">484</span> = <span class="mi">22</span>.</label><small class="alectryon-output"><div><div class="alectryon-goals"><blockquote class="alectryon-goal"><span class="goal-separator"><hr></span><div class="goal-conclusion">SearchSqrt <span class="mi">484</span> = <span class="mi">22</span></div></blockquote></div></div></small><span class="alectryon-wsp">
</span></span><span class="alectryon-wsp">  </span><span class="alectryon-sentence"><input class="alectryon-toggle" id="how-to-optimize-a-search-in-coq-v-chk2" style="display: none" type="checkbox"><label class="alectryon-input" for="how-to-optimize-a-search-in-coq-v-chk2"><span class="nb">vm_compute</span>. <span class="c">(* 30 seconds *)</span></label><small class="alectryon-output"><div><div class="alectryon-goals"><blockquote class="alectryon-goal"><span class="goal-separator"><hr></span><div class="goal-conclusion"><span class="mi">22</span> = <span class="mi">22</span></div></blockquote></div></div></small><span class="alectryon-wsp">
</span></span><span class="alectryon-wsp">  </span><span class="alectryon-sentence"><span class="alectryon-input"><span class="nb">apply</span> eq_refl.</span><span class="alectryon-wsp">
</span></span><span class="alectryon-sentence"><span class="alectryon-input"><span class="kn">Qed</span>. <span class="c">(* 30 seconds *)</span></span><span class="alectryon-wsp">
</span></span><span class="alectryon-wsp">
</span><span class="alectryon-sentence"><input class="alectryon-toggle" id="how-to-optimize-a-search-in-coq-v-chk3" style="display: none" type="checkbox"><label class="alectryon-input" for="how-to-optimize-a-search-in-coq-v-chk3"><span class="kn">Theorem</span> <span class="nf">sqrt_484c</span> (<span class="nv">a</span> : nat) : SearchSqrt <span class="mi">484</span> = <span class="mi">22</span>.</label><small class="alectryon-output"><div><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span><var>a</var><span class="hyp-type"><b>: </b><span>nat</span></span></span><br></div><span class="goal-separator"><hr></span><div class="goal-conclusion">SearchSqrt <span class="mi">484</span> = <span class="mi">22</span></div></blockquote></div></div></small><span class="alectryon-wsp">
</span></span><span class="alectryon-wsp">  </span><span class="alectryon-sentence"><span class="alectryon-input"><span class="nb">apply</span> eq_refl. <span class="c">(* 100 seconds *)</span></span><span class="alectryon-wsp">
</span></span><span class="alectryon-sentence"><span class="alectryon-input"><span class="kn">Qed</span>. <span class="c">(* 50 seconds *)</span></span><span class="alectryon-wsp">
</span></span><span class="alectryon-wsp">
</span><span class="alectryon-sentence"><input class="alectryon-toggle" id="how-to-optimize-a-search-in-coq-v-chk4" style="display: none" type="checkbox"><label class="alectryon-input" for="how-to-optimize-a-search-in-coq-v-chk4"><span class="kn">Theorem</span> <span class="nf">sqrt_484d</span> (<span class="nv">a</span> : nat) : SearchSqrt <span class="mi">484</span> = <span class="mi">22</span>.</label><small class="alectryon-output"><div><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span><var>a</var><span class="hyp-type"><b>: </b><span>nat</span></span></span><br></div><span class="goal-separator"><hr></span><div class="goal-conclusion">SearchSqrt <span class="mi">484</span> = <span class="mi">22</span></div></blockquote></div></div></small><span class="alectryon-wsp">
</span></span><span class="alectryon-wsp">  </span><span class="alectryon-sentence"><input class="alectryon-toggle" id="how-to-optimize-a-search-in-coq-v-chk5" style="display: none" type="checkbox"><label class="alectryon-input" for="how-to-optimize-a-search-in-coq-v-chk5"><span class="nb">vm_compute</span>. <span class="c">(* 60 seconds *)</span></label><small class="alectryon-output"><div><div class="alectryon-goals"><blockquote class="alectryon-goal"><div class="goal-hyps"><span><var>a</var><span class="hyp-type"><b>: </b><span>nat</span></span></span><br></div><span class="goal-separator"><hr></span><div class="goal-conclusion"><span class="mi">22</span> = <span class="mi">22</span></div></blockquote></div></div></small><span class="alectryon-wsp">
</span></span><span class="alectryon-wsp">  </span><span class="alectryon-sentence"><span class="alectryon-input"><span class="nb">apply</span> eq_refl.</span><span class="alectryon-wsp">
</span></span><span class="alectryon-sentence"><span class="alectryon-input"><span class="kn">Qed</span>. <span class="c">(* 60 seconds *)</span></span></span></pre><p>Now try the corresponding function in Python:</p>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">SearchSqrt</span><span class="p">(</span><span class="n">n</span><span class="p">):</span><span class="w">
</span>  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span><span class="w">
</span>    <span class="k">if</span> <span class="n">i</span> <span class="o">*</span> <span class="n">i</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span><span class="w">
</span>      <span class="k">return</span> <span class="n">i</span><span class="w">
</span>  <span class="k">return</span> <span class="mi">0</span>
</pre>
<p>or slightly more literally</p>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">SearchSqrtLoop</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span><span class="w">
</span>  <span class="k">if</span> <span class="n">i</span> <span class="o">*</span> <span class="n">i</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span><span class="w">
</span>    <span class="k">return</span> <span class="n">i</span><span class="w">
</span>  <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span><span class="w">
</span>    <span class="k">return</span> <span class="mi">0</span><span class="w">
</span>  <span class="k">return</span> <span class="n">SearchSqrtLoop</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="w">

</span><span class="k">def</span> <span class="nf">SearchSqrt</span><span class="p">(</span><span class="n">n</span><span class="p">):</span><span class="w">
</span>  <span class="k">return</span> <span class="n">SearchSqrtLoop</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</pre>
<p>The function is nearly instant in Python, but takes minutes in Coq,
depending on exactly how you try to call it. Also curious is that
putting an extra variable in makes <tt class="docutils literal">vm_compute</tt> take twice as long.</p>
<p>I understand that everything is done symbolically in Coq, and thus
slow, but it would be very useful if I could directly evaluate simple
functions. Is there a way to do it? Just using native integers instead
of linked lists would probably help a lot.</p>
</div>
<div class="section" id="answer-user1861759">
<h1>Answer (user1861759)</h1>
<p>You'll get a speedup if you use binary arithmetic instead of unary
arithmetic. Take a look at <tt class="docutils literal">NArith</tt> and <tt class="docutils literal">ZArith</tt>.</p>
<p><a class="reference external" href="http://coq.inria.fr/library/">http://coq.inria.fr/library/</a></p>
<p>You'll also get a speedup if you run your code on OCaml, Haskell, or
Scheme instead.</p>
<p><a class="reference external" href="http://coq.inria.fr/refman/Reference-Manual025.html">http://coq.inria.fr/refman/Reference-Manual025.html</a></p>
</div>
<div class="section" id="answer-anton-trunov">
<h1>Answer (Anton Trunov)</h1>
<p>There is a much more efficient function for finding square roots in
the standard library (<a class="reference external" href="https://coq.inria.fr/library/Coq.Init.Nat.html#sqrt">sqrt</a>):</p>
<blockquote>
The following square root function is linear (and tail-recursive).
With Peano representation, we can't do better. For faster
algorithm, see <tt class="docutils literal">Psqrt</tt>/<tt class="docutils literal">Zsqrt</tt>/<tt class="docutils literal">Nsqrt</tt>...</blockquote>
<pre class="alectryon-io highlight"><!-- Generator: Alectryon --><span class="alectryon-sentence"><span class="alectryon-input"><span class="kn">Require Import</span> Coq.Init.Nat.</span><span class="alectryon-wsp">
</span></span><span class="alectryon-wsp">
</span><span class="alectryon-sentence"><input class="alectryon-toggle" id="how-to-optimize-a-search-in-coq-v-chk6" style="display: none" type="checkbox"><label class="alectryon-input" for="how-to-optimize-a-search-in-coq-v-chk6"><span class="kn">Theorem</span> <span class="nf">sqrt_484a_v2</span> : sqrt <span class="mi">484</span> = <span class="mi">22</span>.</label><small class="alectryon-output"><div><div class="alectryon-goals"><blockquote class="alectryon-goal"><span class="goal-separator"><hr></span><div class="goal-conclusion">sqrt <span class="mi">484</span> = <span class="mi">22</span></div></blockquote></div></div></small><span class="alectryon-wsp">
</span></span><span class="alectryon-wsp">  </span><span class="alectryon-sentence"><input class="alectryon-toggle" id="how-to-optimize-a-search-in-coq-v-chk7" style="display: none" type="checkbox"><label class="alectryon-input" for="how-to-optimize-a-search-in-coq-v-chk7"><span class="kn">Time</span> <span class="nb">apply</span> eq_refl.</label><small class="alectryon-output"><div><div class="alectryon-messages"><blockquote class="alectryon-message">Finished transaction <span class="kr">in</span> <span class="mi">0</span>. secs (<span class="mi">0</span>.u,<span class="mi">0</span>.s) (successful)</blockquote></div></div></small><span class="alectryon-wsp">
</span></span><span class="alectryon-wsp">  </span><span class="alectryon-sentence"><input class="alectryon-toggle" id="how-to-optimize-a-search-in-coq-v-chk8" style="display: none" type="checkbox"><label class="alectryon-input" for="how-to-optimize-a-search-in-coq-v-chk8"><span class="kn">Time</span> <span class="kn">Qed</span>.</label><small class="alectryon-output"><div><div class="alectryon-messages"><blockquote class="alectryon-message">Finished transaction <span class="kr">in</span> <span class="mi">0</span>.<span class="mi">003</span> secs (<span class="mi">0</span>.<span class="mi">003</span>u,<span class="mi">0</span>.s) (successful)</blockquote></div></div></small></span></pre><p>As <tt class="docutils literal">Time</tt> tells us it works much faster (around 200 times faster
than <tt class="docutils literal">sqrt_484a</tt>).</p>
<p>The reason for this performance difference lies in the fact that
<tt class="docutils literal">SearchSqrt</tt> squares its first argument on each iteration, which is
an expensive operation.</p>
<p><tt class="docutils literal">sqrt</tt>'s implementation, on the other hand, is based on the <a class="reference external" href="http://mathworld.wolfram.com/OddNumberTheorem.html">Odd
Number Theorem</a>
(<tt class="docutils literal">1 + 3 + 5 + ...</tt> is a square number). One just needs to count the
number of increasing intervals that can be fitted into the input
argument <tt class="docutils literal">n</tt> and that would be the <a class="reference external" href="https://en.wikipedia.org/wiki/Integer_square_root">integer square root</a> of <tt class="docutils literal">n</tt>. E.g.
<tt class="docutils literal">22 = (1 + 3 + 5 + 7) + 6</tt>, which means there are 4 intervals (of
lengths <tt class="docutils literal">1</tt>, <tt class="docutils literal">3</tt>, <tt class="docutils literal">5</tt>, and <tt class="docutils literal">7</tt>) in 22, so <tt class="docutils literal">sqrt 22 = 4</tt> (and
we are not interested in the residual value 6).</p>
</div>
</div>
</div>
</div></body>
</html>
